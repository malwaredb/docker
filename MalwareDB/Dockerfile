FROM debian:bookworm-slim
LABEL MAINTAINER="Richard Zak <richard@malwaredb.net>"
LABEL SOURCE="https://github.com/malwaredb/"

# Install things we need for compilation
RUN apt-get update && apt-get dist-upgrade -y
RUN apt-get install -y postgresql-15 postgresql-server-dev-15 sudo libfuzzy2 libfuzzy-dev cmake make build-essential git curl libssl-dev libssl3 libgomp1
RUN apt-get install -y protobuf-c-compiler protobuf-compiler libprotobuf-c-dev libprotobuf-c1 libprotobuf-dev libprotoc32 libprotobuf32 libcrypt-dev libcrypt1
RUN apt-get install -y libboost-program-options-dev libboost-filesystem-dev libboost-system-dev libboost-program-options1.74.0 libboost-filesystem1.74.0 libboost-system1.74.0

# Install Rust
RUN curl https://sh.rustup.rs -sSf | bash -s -- -y
ENV PATH="/root/.cargo/bin:${PATH}"

# Download the components
RUN git clone https://github.com/malwaredb/malwaredb-rs.git
RUN git clone https://github.com/malwaredb/LZJD.git
RUN git clone https://github.com/malwaredb/ssdeep_psql.git
RUN git clone --recursive https://github.com/malwaredb/tlsh_pg.git
RUN git clone --recursive https://github.com/malwaredb/sdhash_psql.git

# Compile, Install, and Delete sources for the latest release of MalwareDB
RUN cd malwaredb-rs && git checkout `git describe --abbrev=0` &&. $HOME/.cargo/env && cargo build --release && cp target/release/mdb_server /usr/bin/
RUN rm -rf malwaredb-rs

# Compile, Install, and Delete sources for LZJD
RUN cd LZJD/src/ && mkdir build && cd build && cmake .. -DCMAKE_BUILD_TYPE=Release && make && cp lzjd_psql.so `pg_config --pkglibdir`
RUN rm -rf LZJD

# Compile, Install, and Delete sources for SSDeep
RUN cd ssdeep_psql && make && make install
RUN rm -rf ssdeep_psql

# Compile, Install, and Delete sources for TLSH
RUN cd tlsh_pg/tlsh && ./make.sh && cd .. && mkdir build && cd build && cmake .. -DCMAKE_BUILD_TYPE=Release && make && cp tlsh_psql.so `pg_config --pkglibdir`
RUN rm -rf tlsh_pg

# Compile, Install, and Delete sources for SDHash
RUN cd sdhash_psql/sdhash && make && cd .. && make sdhash_psql.so && make install
RUN rm -rf sdhash_psql

# End: cleanup
# Don't need to bloat the image with development tools once we're done with them
RUN apt-get remove -y postgresql-server-dev-15 libfuzzy-dev cmake make build-essential git curl libssl-dev protobuf-c-compiler protobuf-compiler
RUN apt-get remove -y libboost-program-options-dev libboost-filesystem-dev libboost-system-dev libprotobuf-c-dev libprotobuf-dev libcrypt-dev
RUN apt-get autoremove -y && apt-get clean && rm -rf $HOME/.cargo $HOME/.rustup

ENV PGDATA /var/lib/postgresql/data
RUN mkdir -p "$PGDATA" && chown -R postgres:postgres "$PGDATA" && chmod 777 "$PGDATA"
VOLUME /var/lib/postgresql/data
RUN mkdir /malware_samples
VOLUME /malware_samples

COPY start.sh .
RUN chmod +x start.sh

# Start MalwareDB, and do initial setup for Postgres
ENTRYPOINT ["./start.sh"]

# For fast shutdown mode for Postgres
# https://github.com/docker-library/postgres/blob/dd68d91377a3631b36a23f2e4795f6189db4ba12/15/bullseye/Dockerfile#L188
STOPSIGNAL SIGINT
EXPOSE 8080/tcp
